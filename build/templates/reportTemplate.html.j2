<!DOCTYPE html>
<html lang="en">
   <head>
      <link href="./static/style.css" rel="stylesheet">
      <link href="./static/bootstrap-theme.min.css" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css?family=Noto+Sans" rel="stylesheet">
      <title>Report generated on {{ datetime }}</title>
   </head>
   <body>
      <header class="header">
         <nav class="navbar navbar-expand-lg navbar-dark">
            <!-- Navbar content -->
            <div class="container">
               <a class="navbar-brand" href="https://www2.gov.bc.ca">
                  <img class="img-fluid d-none d-md-block" src="https://developer.gov.bc.ca/static/BCID_H_rgb_rev-20eebe74aef7d92e02732a18b6aa6bbb.svg" width="177" height="44" alt="B.C. Government Logo">
               </a>
               <div class="navbar-brand">
                  {{ namespace }} OpenShift Config Check
               </div>
            </div>
         </nav>
      </header>
      <main role="main">
         <div class="container">
            <h2>Config assessment report for the namespace {{ namespace }} in the {{ clusterName }} cluster</h2>
            <div class="report-explanation">
               <p>The AppAssessment tool assesses configuration of pods within a specific Openshift namespace and identifies the misconfigured 
               or missing settings based on what is considered best practices by RedHat and the Platform Services Team.
               Checks are performed through the calls to Openshift API, and compared to expected values. Documentation on application health 
               checks can be found <a href="https://docs.openshift.com/container-platform/4.9/applications/application-health.html" target="_blank">here</a>. 
               If your team is aware of additional checks that can be added to the list, please, ping us in #devops-operations channel in 
               Rocketchat. Configuring applications pods in acccordance with best practices improves the resiliency, performance and security 
               posture of the application.</p>

               <strong>Note: The report produced by the AppAssessment tool provides recommendations only, it is the responsibility of the product team to review the recommendations and implement as necessary.</strong>
            </div>
            <hr>
            <div>
               <div class="table-legend">
                  <h3>Legend</h3>
                  <table>
                     <tr>
                        <td>
                           <div class="status-icon pass">
                              &#10004
                           </div>
                        </td>
                        <td>
                           Setting is applicable and is correct
                        </td>
                     </tr>
                     <tr>
                        <td>
                           <div class="status-icon warning">
                              !
                           </div>
                        </td>
                        <td>
                           Setting may or may not be applicable, or the value may or may not be correct. Refer to documentation for more detail.
                        </td>
                     </tr>
                     <tr>
                        <td>
                           <div class="status-icon fail">
                              X
                           </div>
                        </td>
                        <td>
                           Either inapplicable or incorrect
                        </td>
                     </tr>
                     <tr>
                        <td>
                           N/A
                        </td>
                        <td>
                           Setting is not applicable for this deployment type
                        </td>
                     </tr>
                  </table>
               </div>
            </div>
            <hr/>
            <h3>Details</h3>
            {% if jenkinsPods|length > 0 %}
               <div id="jenkins-warning">
                  <h4>Jenkins Pods</h4>
                  It looks like one or more Jenkins instances has been found in your tools namespace. <strong>Use of Jenkins is highly discouraged on the Platform due to
                  its high resource consumption.</strong> Please consider switching to other modern and more secure 
                  <a href="https://developer.gov.bc.ca/CICD-with-Pipeline-Automation" target="_blank">automation technologies available on the
                  Platform..</a>
                  <p/><p/>
               </div>
               Pods: 
               {% for pod in   jenkinsPods %}
                  <h4>Pod: {{ pod['name'] }}</h4>
                  <table class="table-bordered" id="{{ workloadName }}">
                     <tr>
                        <td>
                           Config point
                        </td>
                        <td>
                           Allocation
                        </td>
                        <td>
                           Recommended
                        </td>
                        <td>
                           Meets best pratices?
                        </td>
                     </tr>
                     <tr>
                        <td>
                           Limits
                        </td>
                     </tr>
                     <tr>
                        <td>
                           CPU 
                        </td>
                        <td>
                           {{ pod['cpuLimit'] }}
                        </td>
                        <td>
                           1000m
                        </td>
                        <td>
                        {% if pod['cpuLimitMeetsBP'] %}
                           <div class="status-icon pass">
                              &#10004
                           </div>
                           Yes
                        {% else %}
                           <div class="status-icon warning">
                              !
                           </div>
                           No
                        {% endif %}
                        </td>
                     </tr>
                     <tr>
                        <td>
                           memory 
                        </td>
                        <td>
                           {{ pod['memoryLimit'] }}
                        </td>
                        <td>
                           1-2Gi
                        </td>
                         <td>
                        {% if pod['memLimitMeetsBP'] %}
                           <div class="status-icon pass">
                              &#10004
                           </div>
                           Yes
                        {% else %}
                           <div class="status-icon warning">
                              !
                           </div>
                           No
                        {% endif %}
                        </td>
                     </tr>
                     <tr>
                        <td>
                           Requests
                        </td>
                     </tr>
                     <tr>
                        <td>
                           CPU 
                        </td>
                        <td>
                           {{ pod['cpuRequest'] }}
                        </td>
                        <td>
                           100m
                        </td>
                         <td>
                        {% if pod['cpuReqMeetsBP'] %}
                           <div class="status-icon pass">
                              &#10004
                           </div>
                           Yes
                        {% else %}
                           <div class="status-icon warning">
                              !
                           </div>
                           No
                        {% endif %}
                        </td>
                     </tr>
                     <tr>
                        <td>
                           memory 
                        </td>
                        <td>
                           {{ pod['memoryRequest'] }}
                        </td>
                        <td>
                           512Mi
                        </td>
                         <td>
                        {% if pod['memReqMeetsBP'] %}
                           <div class="status-icon pass">
                              &#10004
                           </div>
                           Yes
                        {% else %}
                           <div class="status-icon warning">
                              !
                           </div>
                           No
                        {% endif %}
                        </td>
                     </tr>
                  </table>
               {% endfor %}
            {% endif %}
            <div id="imagestream-info">
               <h4>Imagestreams</h4>
               There {{ 'is' if imagestreams|length == 1 else 'are'}} {{ imagestreams|length }} 
               imagestream{{'' if imagestreams|length == 1 else 's'}} running in namespace {{ namespace }} <p/>
               Total size of imagestreams: {{ imagestreamSize }} MB
            </div>
            <div id="quick-links">
            {% if podsWithFailedChecks|length == 0 %}
               Hurray! All pods have passed all their status checks!
            {% else %}
               <h4>Jump to pods with errors or warnings:</h4>
               {% for podWithFailedCheck in podsWithFailedChecks %}
                  <a href="#{{ podWithFailedCheck }}">{{ podWithFailedCheck }} </a>
               {% endfor %}
            {% endif %}
            </div>
            {% for workloadName in workloadNames %} 
            <table class="table-bordered" id="{{ workloadName }}">
               <tr>
                  <td>
                     <h4>Config Setting</h4>
                  </td>
                  <td>
                     <h4>Pod: {{ workloadName }}</h4>
                  </td>
               </tr>
               {% for checkName in results.keys() %} 
               <tr>
                  <td>
                     <a target="_blank" title="{{ checksInfo[checkName].title }}" href="{{ checksInfo[checkName].href }}"> {{ checkName }}</a>
                  </td>
                  <td>
                     <div class="check-details">
                        {% if results[checkName][workloadName]['status'] == 'fail' %}
                        <div class="status-icon fail">
                           X
                        </div>
                        {% elif results[checkName][workloadName]['status'] == 'warning' %}
                        <div class="status-icon warning">
                           !
                        </div>
                        {% elif results[checkName][workloadName]['status'] == 'pass' %}
                        <div class="status-icon pass">
                           &#10004
                        </div>
                        {% else %}
                        N/A
                        {% endif %}
                        <div class="check-detail"a>{{ results[checkName][workloadName]['text'] }}</div>
                     </div>
                  </td>
               </tr>
               {% endfor %}
            </table>
            <hr/>
            {% endfor %} 
         </div>
      </main>
      <footer class="footer">
         <nav class="navbar navbar-expand-lg navbar-dark">
            <div class="container">
               <ul class="navbar-nav">
                  <li class="nav-item">
                     <a class="nav-link" href="https://www2.gov.bc.ca/gov/content?id=79F93E018712422FBC8E674A67A70535" target="_blank">Disclaimer</a>
                  </li>
                  <li class="nav-item">
                     <a class="nav-link" href="https://www2.gov.bc.ca/gov/content?id=9E890E16955E4FF4BF3B0E07B4722932" target="_blank">Privacy</a>
                  </li>
                  <li class="nav-item">
                     <a class="nav-link" href="https://www2.gov.bc.ca/gov/content?id=E08E79740F9C41B9B0C484685CC5E412" target="_blank">Accessibility</a>
                  </li>
                  <li class="nav-item">
                     <a class="nav-link" href="https://www2.gov.bc.ca/gov/content?id=1AAACC9C65754E4D89A118B875E0FBDA" target="_blank">Copyright</a>
                  </li>
                  <li class="nav-item">
                     <a class="nav-link" href="https://www2.gov.bc.ca/gov/content?id=6A77C17D0CCB48F897F8598CCC019111" target="_blank">Contact Us</a>
                  </li>
               </ul>
            </div>
         </nav>
      </footer>
   </body>
</html>
